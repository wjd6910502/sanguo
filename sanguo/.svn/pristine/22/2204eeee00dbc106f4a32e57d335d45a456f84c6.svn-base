function OnCommand_TowerEndBattle(player, role, arg, others)
	player:Log("OnCommand_TowerEndBattle, "..DumpTable(arg).." "..DumpTable(others))

	if role._roledata._status._time_line ~= G_ROLE_STATE["TOWER"] then
		return
	end	
	
	local resp = NewCommand("TowerEndBattle_Re")
	local size = table.getn(arg.hero)

	--检查武将信息
	for i = 1, size do
		local hero = arg.hero[i]
		--判断是否在英雄列表中
		local f = role._roledata._hero_hall._heros:Find(hero.id)
		if f == nil then
			resp.restcode = G_ERRCODE["TOWER_PARAM_HERO_NOT_EXIST"]
			player:SendToClient(SerializeCommand(resp))
			return
		end
	end

	--处理武将信息
	for i = 1, size do
		local hero = arg.hero[i]
		local f = role._roledata._tower_data._injured_hero:Find(hero.id)
		if f ~= nil then
			f._hp = hero.hp
			f._anger = hero.anger
			if f._hp == 0 then
				role._roledata._tower_data._injured_hero:Delete(hero.id)
				local deadhero = CACHE.Int()
				deadhero._value = hero.id
				role._roledata._tower_data._dead_hero:Insert(hero.id, deadhero)
			end
		else
			if hero.hp == 0 then
				local deadhero = CACHE.Int()
				deadhero._value = hero.id
				role._roledata._tower_data._dead_hero:Insert(hero.id, deadhero)
			else
				local towerhero = CACHE.ShiLianHeroInfo()
				towerhero._id  = hero.id
				towerhero._hp  = hero.hp
				towerhero._anger  = hero.anger
				role._roledata._tower_data._injured_hero:Insert(hero.id, towerhero)
			end
		end
	end
	
	--处理敌人血量
	size = table.getn(arg.army)
	for i = 1, size do
		local army = arg.army[i]
		local tower_data = role._roledata._tower_data
		local fs = tower_data._cur_attack_all_army_info:Find(tower_data._select_layer_difficulty)
		if fs:Size() ~= 0 then
			local f = fs:Find(army.id)
			if f ~= nil then
				f._hp = army.hp
				f._anger = army.anger
			end
		end
	end
	
	--玩家胜利
	if win_flag == 1 then
		--玩家增加星星
			
		
		--增加打过的信息，map肯定不存在当前层数据
		local tower_data = role._roledata._tower_data
		local army_info = CACHE.TowerArmyInfo()
		army_info._layer = role._roledata._tower_data._cur_layer
		army_info._star = 1 --先写死，不知道得到多少星星呢
		army_info._difficulty = tower_data._select_layer_difficulty		
		local army_it = tower_data._cur_attack_all_army_info:Find(tower_data._select_layer_difficulty):SeekToBegin()
        local army = army_it:GetValue()
        while army ~= nil do
			local insert_data = CACHE.Int()
			insert_data._value = army._id
			army_info._army_info:PushBack(insert_data)
            army_it:Next()
            army = army_it:GetValue()
        end
		tower_data._army_info:Insert(tower_data._cur_layer, army_info) 

		--删除当前敌人数据
		tower_data._cur_attack_all_army_info:Clear()
		tower_data._select_layer_difficulty = 0

		if tower_data._cur_layer == 1 and tower_data._select_layer_difficulty == 3 then
			tower_data._win_flag = 1
		end

		if tower_data._win_flag == 1 then
			tower_data._history_layer = tower_data._cur_layer
		end	

		tower_data._cur_layer = tower_data._cur_layer + 1
	else
		--只有失败才会返回敌人信息吧？胜利敌人都死了
		tower_data._win_flag = 0
		local army_it = role._roledata._tower_data._cur_attack_all_army_info:SeekToBegin()
		local army = army_it:GetValue()
		local info = {}
		while injured ~= nil do
			info.id = army._id
			info.hp = army._hp
			info.anger = army._anger
			resp.army[#resp.army + 1] = info
			army_it:Next()
			army = army_it:GetValue()
		end 
	end

	resp.hero = arg.hero
	resp.retcode = G_ERRCODE["SUCCESS"]
	resp.win_flag = arg.win_flag 
	player:SendToClient(SerializeCommand(resp))

	role._roledata._status._time_line = G_ROLE_STATE["FREE"]
	--查看操作和种子，准备做后面的验证
	--arg.operations
	--role._roledata._status._fight_seed
end
